<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>UTEBookStore - Quản lý khuyến mãi</title>

	<link rel="stylesheet" th:href="@{/css/admin-layout.css}">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

	<style>
		/* Layout */
		body {
			background-color: #f8f9fa;
		}

		.wrapper {
			display: flex;
			min-height: 100vh;
		}

		.sidebar {
			width: 250px;
			min-height: 100vh;
			position: fixed;
			left: 0;
			top: 60px;
			z-index: 100;
			padding: 20px;
			overflow-y: auto;
			background: #fff;
			border-right: 1px solid #e3e6ec;
		}

		.content-wrapper {
			padding-top: 60px;
			margin-left: 250px;
			width: calc(100% - 250px);
			min-height: 100vh;
			background-color: #f8f9fa;
		}

		.main-content {
			padding: 20px;
		}

		.header {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			height: 60px;
			z-index: 1000;
			background: #fff;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		/* Card styles */
		.card {
			border: none;
			border-radius: 0.5rem;
			box-shadow: 0 0.15rem 1.75rem 0 rgba(33, 40, 50, 0.15);
			margin-bottom: 1.5rem;
		}

		.card-header {
			background-color: #fff;
			border-bottom: 1px solid #e3e6ec;
			padding: 1rem 1.35rem;
		}

		/* Table styles */
		.table {
			margin-bottom: 0;
		}

		.table th {
			border-top: none;
			background-color: #f8f9fa;
			font-weight: 600;
			text-transform: uppercase;
			font-size: 0.85rem;
			padding: 1rem;
			vertical-align: middle;
		}

		.table td {
			padding: 1rem;
			vertical-align: middle;
		}

		/* Status and values */
		.discount-value {
			font-weight: 600;
			color: #dc3545;
			font-size: 1.1rem;
		}

		.date-range {
			font-size: 0.875rem;
			color: #6c757d;
		}

		.form-check-input.toggle-status {
			width: 3em;
			height: 1.5em;
			cursor: pointer;
		}

		/* Buttons */
		.btn-sm {
			padding: 0.4rem 0.8rem;
			font-size: 0.875rem;
		}

		.btn-outline-primary {
			border-color: #0d6efd;
		}

		.btn-outline-primary:hover {
			background-color: #0d6efd;
			color: white;
		}

		.btn-outline-danger {
			border-color: #dc3545;
		}

		.btn-outline-danger:hover {
			background-color: #dc3545;
			color: white;
		}

		/* Search box */
		.search-box {
			border-radius: 0.5rem;
			border: 1px solid #e3e6ec;
		}

		.search-box:focus {
			border-color: #0d6efd;
			box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
		}

		/* Pagination */
		.pagination {
			margin-bottom: 0;
		}

		.page-link {
			padding: 0.5rem 0.85rem;
			color: #0d6efd;
			background-color: #fff;
			border: 1px solid #dee2e6;
		}

		.page-link:hover {
			background-color: #e9ecef;
		}

		.page-item.active .page-link {
			background-color: #0d6efd;
			border-color: #0d6efd;
		}

		/* Toast */
		.toast {
			position: fixed;
			bottom: 1rem;
			right: 1rem;
			min-width: 250px;
		}

		/* Responsive */
		@media (max-width: 768px) {
			.sidebar {
				width: 200px;
			}

			.content-wrapper {
				margin-left: 200px;
				width: calc(100% - 200px);
			}
		}
	</style>
</head>

<body>
	<!-- Header -->
	<div th:replace="admin/layout/header :: header"></div>

	<div class="wrapper d-flex">
		<!-- Sidebar -->
		<div th:replace="admin/layout/sidebar :: sidebar"></div>

		<!-- Main Content -->
		<div class="content-wrapper w-100">
			<div class="container-fluid">
				<div class="main-content">
					<!-- Page Title -->
					<div class="d-flex justify-content-between align-items-center mb-4">
						<h1 class="h3 mb-0 text-gray-800">Quản lý khuyến mãi</h1>
						<a th:href="@{/admin/promotions/create}" class="btn btn-primary">
							<i class="fas fa-plus me-1"></i>Thêm khuyến mãi
						</a>
					</div>

					<!-- Search -->
					<div class="card mb-4">
						<div class="card-body">
							<form th:action="@{/admin/promotions}" method="get">
								<div class="row g-2 align-items-center">
									<div class="col-auto flex-grow-1">
										<input type="text" class="form-control search-box" name="search"
											th:value="${search}" placeholder="Tìm kiếm mã khuyến mãi...">
									</div>
									<div class="col-auto">
										<button type="submit" class="btn btn-primary">
											<i class="fas fa-search me-1"></i>Tìm kiếm
										</button>
									</div>
								</div>
							</form>
						</div>
					</div>

					<!-- Promotions List -->
					<div class="card">
						<div class="table-responsive">
							<table class="table table-hover">
								<thead>
									<tr>
										<th>Mã khuyến mãi</th>
										<th>Loại giảm giá</th>
										<th>Giá trị</th>
										<th>Thời gian áp dụng</th>
										<th class="text-center">Trạng thái</th>
										<th class="text-end">Thao tác</th>
									</tr>
								</thead>
								<tbody>
									<tr th:each="promotion : ${promotions}">
										<td>
											<div class="fw-bold" th:text="${promotion.code}"></div>
											<div class="small text-muted" th:if="${promotion.maxUses != null}">
												Giới hạn: <span th:text="${promotion.maxUses}"></span> lượt
											</div>
										</td>
										<td>
											<span
												th:text="${promotion.discountType == 'PERCENT' ? 'Giảm theo %' : 'Giảm giá trực tiếp'}"></span>
										</td>
										<td>
											<div class="discount-value">
												<span
													th:text="${#numbers.formatDecimal(promotion.discount, 0, 'COMMA', 0, 'POINT')}"></span>
												<span
													th:text="${promotion.discountType == 'PERCENT' ? '%' : 'đ'}"></span>
											</div>
											<div class="small text-muted" th:if="${promotion.minOrderAmount != null}">
												Đơn tối thiểu: <span
													th:text="${#numbers.formatDecimal(promotion.minOrderAmount, 0, 'COMMA', 0, 'POINT')}">đ</span>
											</div>
										</td>
										<td>
											<div class="date-range">
												<div>Bắt đầu: <span
														th:text="${#temporals.format(promotion.startDate, 'dd/MM/yyyy HH:mm')}"></span>
												</div>
												<div>Kết thúc: <span
														th:text="${#temporals.format(promotion.endDate, 'dd/MM/yyyy HH:mm')}"></span>
												</div>
											</div>
										</td>
										<td class="text-center">
											<div class="form-check form-switch d-flex justify-content-center">
												<input class="form-check-input toggle-status" type="checkbox"
													th:checked="${promotion.isActive}" th:data-id="${promotion.id}">
											</div>
										</td>
										<td class="text-end">
											<div class="btn-group">
												<a th:href="@{/admin/promotions/edit/{id}(id=${promotion.id})}"
													class="btn btn-sm btn-outline-primary">
													<i class="fas fa-edit"></i>
												</a>
												<button type="button" class="btn btn-sm btn-outline-danger"
													th:onclick="'deletePromotion(' + ${promotion.id} + ')'">
													<i class="fas fa-trash"></i>
												</button>
											</div>
										</td>
									</tr>
								</tbody>
							</table>
						</div>

						<!-- Pagination -->
						<div class="card-footer" th:if="${totalPages > 1}">
							<nav>
								<ul class="pagination justify-content-center mb-0">
									<li class="page-item" th:classappend="${currentPage == 0 ? 'disabled' : ''}">
										<a class="page-link"
											th:href="@{/admin/promotions(page=${currentPage-1}, search=${search})}">
											<i class="fas fa-chevron-left"></i>
										</a>
									</li>
									<li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages-1)}"
										th:classappend="${currentPage == i ? 'active' : ''}">
										<a class="page-link" th:href="@{/admin/promotions(page=${i}, search=${search})}"
											th:text="${i+1}"></a>
									</li>
									<li class="page-item"
										th:classappend="${currentPage == totalPages-1 ? 'disabled' : ''}">
										<a class="page-link"
											th:href="@{/admin/promotions(page=${currentPage+1}, search=${search})}">
											<i class="fas fa-chevron-right"></i>
										</a>
									</li>
								</ul>
							</nav>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Toast Notification -->
	<div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
		<div class="d-flex">
			<div class="toast-body"></div>
			<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
		</div>
	</div>

	<!-- Scripts -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script>
		// Toast notification
		function showToast(message, type = 'success') {
			const toast = document.querySelector('.toast');
			toast.className = `toast align-items-center text-white bg-${type} border-0`;
			document.querySelector('.toast-body').textContent = message;
			new bootstrap.Toast(toast).show();
		}

		// Toggle status
		document.querySelectorAll('.toggle-status').forEach(checkbox => {
			checkbox.addEventListener('change', function () {
				const promotionId = this.dataset.id;
				fetch(`/admin/promotions/${promotionId}/toggle-status`, {
					method: 'POST',
					headers: {'Content-Type': 'application/json'}
				})
					.then(response => response.json())
					.then(data => {
						showToast(`Đã ${data.status ? 'kích hoạt' : 'vô hiệu hóa'} khuyến mãi`);
					})
					.catch(error => {
						console.error('Error:', error);
						this.checked = !this.checked;
						showToast('Có lỗi xảy ra', 'danger');
					});
			});
		});

		// Delete promotion
		function deletePromotion(id) {
			if (confirm('Bạn có chắc muốn xóa khuyến mãi này?')) {
				fetch(`/admin/promotions/delete/${id}`, {
					method: 'POST'
				})
					.then(response => {
						if (response.ok) {
							showToast('Xóa khuyến mãi thành công');
							setTimeout(() => location.reload(), 1000);
						} else {
							throw new Error('Delete failed');
						}
					})
					.catch(error => {
						console.error('Error:', error);
						showToast('Có lỗi xảy ra khi xóa khuyến mãi', 'danger');
					});
			}
		}
	</script>
</body>

</html>