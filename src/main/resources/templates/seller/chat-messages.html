<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
   <title>Chat Messages - UTE Book Store</title>
   <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
   <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
   <style>
       .main-container {
           height: calc(100vh - 56px);
           margin-top: 56px;
       }
       .chat-container {
           height: 100%;
           display: flex;
           flex-direction: column;
       }
       .chat-list {
           height: 100%;
           overflow-y: auto;
           border-right: 1px solid #dee2e6;
       }
       .chat-messages {
           flex: 1;
           overflow-y: auto;
           padding: 1rem;
       }
       .message-bubble {
           max-width: 75%;
           margin-bottom: 1rem;
           padding: 0.75rem;
           border-radius: 15px;
       }
       .sent {
           margin-left: auto;
           background: #0d6efd;
           color: white;
       }
       .received {
           margin-right: auto;
           background: #f8f9fa;
       }
       .chat-input {
           padding: 1rem;
           background: #f8f9fa;
           border-top: 1px solid #dee2e6;
       }
       .chat-item {
           padding: 1rem;
           border-bottom: 1px solid #dee2e6;
           cursor: pointer;
       }
       .chat-item:hover {
           background: #f8f9fa;
       }
       .chat-item.active {
           background: #e9ecef;
       }
       .empty-state {
           height: 100%;
           display: flex;
           align-items: center;
           justify-content: center;
           color: #6c757d;
       }
   </style>
</head>
<body>
   <div th:replace="seller/layout/header :: header"></div>

   <div class="container-fluid main-container">
       <div class="row h-100">
           <!-- Sidebar -->
           <div class="col-md-2 bg-light">
               <div th:replace="seller/layout/sidebar :: sidebar"></div>
           </div>

           <!-- Main Chat Area -->
           <div class="col-md-10 px-0">
               <div class="chat-container">
                   <div class="row h-100 g-0">
                       <!-- Conversation List -->
                       <div class="col-md-4 chat-list">
                           <div class="p-3 border-bottom">
                               <h5 class="mb-0">Conversations</h5>
                           </div>
                           <div id="conversationsList">
                               <div class="empty-state">
                                   <p>No conversations yet</p>
                               </div>
                           </div>
                       </div>

                       <!-- Messages Area -->
                       <div class="col-md-8 d-flex flex-column">
                           <div id="chatMessages" class="chat-messages">
                               <div class="empty-state">
                                   <p>Select a conversation to start chatting</p>
                               </div>
                           </div>

                           <!-- Input Area -->
                           <div class="chat-input">
                               <form id="messageForm" class="d-flex gap-2">
                                   <input type="text" class="form-control" id="messageInput" 
                                          placeholder="Type your message..." disabled>
                                   <button type="submit" class="btn btn-primary" disabled>
                                       Send
                                   </button>
                               </form>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <input type="hidden" id="currentUserId" th:value="${userId}"/>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

   <script th:inline="javascript">
       let stompClient = null;
       let selectedUser = null;
       const currentUserId = document.getElementById('currentUserId').value;

       function connect() {
           const socket = new SockJS('/ws/chat');
           stompClient = Stomp.over(socket);
           
           stompClient.connect({}, () => {
               stompClient.subscribe('/topic/messages/' + currentUserId, onMessageReceived);
               loadConversations();
           });
       }

       async function loadConversations() {
           try {
               const response = await fetch('/seller/chat/conversations');
               const conversations = await response.json();
               
               const conversationsList = document.getElementById('conversationsList');
               if (conversations.length === 0) {
                   conversationsList.innerHTML = `
                       <div class="empty-state">
                           <p>No conversations yet</p>
                       </div>
                   `;
                   return;
               }

               conversationsList.innerHTML = conversations.map(conv => `
                   <div class="chat-item ${conv.sender.id === selectedUser ? 'active' : ''}" 
                        onclick="selectConversation(${conv.sender.id})">
                       <div class="d-flex justify-content-between">
                           <h6 class="mb-1">${conv.sender.fullName}</h6>
                           <small class="text-muted">${formatDate(conv.sentAt)}</small>
                       </div>
                       <p class="mb-0 text-truncate">${conv.content}</p>
                   </div>
               `).join('');
           } catch (error) {
               console.error('Error loading conversations:', error);
           }
       }

       async function selectConversation(userId) {
           selectedUser = userId;
           document.querySelectorAll('.chat-item').forEach(item => 
               item.classList.remove('active')
           );
           document.querySelector(`.chat-item[onclick*="${userId}"]`)
               ?.classList.add('active');
           
           document.getElementById('messageInput').disabled = false;
           document.querySelector('#messageForm button').disabled = false;
           
           await loadMessages(userId);
       }

       async function loadMessages(userId) {
           try {
               const response = await fetch(`/seller/chat/messages/${userId}`);
               const messages = await response.json();
               
               const chatMessages = document.getElementById('chatMessages');
               if (messages.length === 0) {
                   chatMessages.innerHTML = `
                       <div class="empty-state">
                           <p>No messages in this conversation</p>
                       </div>
                   `;
                   return;
               }

               chatMessages.innerHTML = messages.map(msg => `
                   <div class="message-bubble ${msg.sender.id === currentUserId ? 'sent' : 'received'}">
                       <div class="message-content">
                           <p class="mb-1">${msg.content}</p>
                           <small class="text-muted">${formatDate(msg.sentAt)}</small>
                       </div>
                   </div>
               `).join('');
               
               chatMessages.scrollTop = chatMessages.scrollHeight;
           } catch (error) {
               console.error('Error loading messages:', error);
           }
       }

       function sendMessage(event) {
           event.preventDefault();
           if (!selectedUser) return;
           
           const messageInput = document.getElementById('messageInput');
           const content = messageInput.value.trim();
           if (!content) return;

           const message = {
               content,
               receiverId: selectedUser,
               senderId: currentUserId
           };
           
           stompClient.send("/app/chat.send", {}, JSON.stringify(message));
           messageInput.value = '';
       }

       function onMessageReceived(payload) {
           const message = JSON.parse(payload.body);
           if (selectedUser === message.sender.id) {
               appendMessage(message);
           }
           loadConversations();
       }

       function appendMessage(message) {
           const chatMessages = document.getElementById('chatMessages');
           const messageDiv = document.createElement('div');
           messageDiv.className = `message-bubble ${message.sender.id === currentUserId ? 'sent' : 'received'}`;
           messageDiv.innerHTML = `
               <div class="message-content">
                   <p class="mb-1">${message.content}</p>
                   <small class="text-muted">${formatDate(message.sentAt)}</small>
               </div>
           `;
           chatMessages.appendChild(messageDiv);
           chatMessages.scrollTop = chatMessages.scrollHeight;
       }

       function formatDate(date) {
           return new Date(date).toLocaleTimeString('en-US', {
               hour: '2-digit',
               minute: '2-digit'
           });
       }

       document.getElementById('messageForm').addEventListener('submit', sendMessage);
       document.addEventListener('DOMContentLoaded', connect);
   </script>
</body>
</html>